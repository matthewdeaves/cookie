name: Coverage & Metrics Report

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish-coverage:
    name: Publish Coverage & Metrics to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v6

      - name: Download frontend coverage
        uses: actions/download-artifact@v7
        with:
          name: frontend-coverage
          path: coverage/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download backend coverage
        uses: actions/download-artifact@v7
        with:
          name: backend-coverage
          path: coverage/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download backend complexity
        uses: actions/download-artifact@v7
        with:
          name: backend-complexity
          path: complexity/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend complexity
        uses: actions/download-artifact@v7
        with:
          name: frontend-complexity
          path: complexity/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend duplication
        uses: actions/download-artifact@v7
        with:
          name: frontend-duplication
          path: duplication/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend security
        uses: actions/download-artifact@v7
        with:
          name: frontend-security
          path: security/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download backend security
        uses: actions/download-artifact@v7
        with:
          name: backend-security
          path: security/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend bundle
        uses: actions/download-artifact@v7
        with:
          name: frontend-bundle
          path: bundle/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download legacy lint
        uses: actions/download-artifact@v7
        with:
          name: legacy-lint
          path: legacy/lint
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download legacy duplication
        uses: actions/download-artifact@v7
        with:
          name: legacy-duplication
          path: legacy/duplication
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download backend duplication
        uses: actions/download-artifact@v7
        with:
          name: backend-duplication
          path: duplication/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch existing history from gh-pages
        run: |
          mkdir -p site/coverage/history
          # Try to fetch existing history from gh-pages branch
          if git fetch origin gh-pages --depth=1 2>/dev/null; then
            git checkout origin/gh-pages -- coverage/history/all.json 2>/dev/null && \
              mv coverage/history/all.json site/coverage/history/ || \
              echo '{"entries":[]}' > site/coverage/history/all.json
          else
            echo '{"entries":[]}' > site/coverage/history/all.json
          fi
          echo "History file contents:"
          cat site/coverage/history/all.json

      - name: Generate coverage and metrics dashboard
        run: |
          # Create site structure with root landing page and coverage subdirectory
          mkdir -p site/coverage/frontend
          mkdir -p site/coverage/backend
          mkdir -p site/coverage/complexity
          mkdir -p site/coverage/security
          mkdir -p site/coverage/duplication
          mkdir -p site/coverage/bundle
          mkdir -p site/coverage/badges
          mkdir -p site/coverage/api
          mkdir -p site/coverage/legacy

          # Copy coverage reports if they exist
          if [ -d "coverage/frontend" ]; then
            cp -r coverage/frontend/* site/coverage/frontend/ 2>/dev/null || true
          fi
          if [ -d "coverage/backend/htmlcov" ]; then
            cp -r coverage/backend/htmlcov site/coverage/backend/ 2>/dev/null || true
          fi

          # Copy complexity reports
          if [ -d "complexity/backend" ]; then
            cp -r complexity/backend/* site/coverage/complexity/ 2>/dev/null || true
          fi
          if [ -d "complexity/frontend" ]; then
            cp -r complexity/frontend/* site/coverage/complexity/ 2>/dev/null || true
          fi

          # Copy security reports
          if [ -d "security/frontend" ]; then
            cp -r security/frontend/* site/coverage/security/ 2>/dev/null || true
          fi
          if [ -d "security/backend" ]; then
            cp -r security/backend/* site/coverage/security/ 2>/dev/null || true
          fi

          # Copy duplication and bundle reports
          if [ -d "duplication/frontend" ]; then
            mkdir -p site/coverage/duplication/frontend
            cp -r duplication/frontend/* site/coverage/duplication/frontend/ 2>/dev/null || true
          fi
          if [ -d "duplication/backend" ]; then
            mkdir -p site/coverage/duplication/backend
            cp -r duplication/backend/* site/coverage/duplication/backend/ 2>/dev/null || true
          fi
          if [ -d "bundle/frontend" ]; then
            cp -r bundle/frontend/* site/coverage/bundle/ 2>/dev/null || true
          fi

          # Copy legacy reports
          if [ -d "legacy/lint" ]; then
            cp -r legacy/lint/* site/coverage/legacy/ 2>/dev/null || true
          fi
          if [ -d "legacy/duplication" ]; then
            mkdir -p site/coverage/legacy/duplication
            cp -r legacy/duplication/* site/coverage/legacy/duplication/ 2>/dev/null || true
          fi

          # Inject "Back to Dashboard" link into all report HTML files
          python3 << 'PYEOF'
          import os
          import glob

          back_link = '<div style="position:fixed;top:10px;right:10px;z-index:9999;"><a href="/cookie/coverage/" style="background:#0066cc;color:white;padding:8px 16px;border-radius:6px;text-decoration:none;font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">&#8592; Back to Dashboard</a></div>'

          for html_file in glob.glob('site/coverage/**/*.html', recursive=True):
              if html_file.endswith('index.html') and 'site/coverage/index.html' == html_file:
                  continue  # Skip main dashboard
              try:
                  with open(html_file, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                  if '</body>' in content and back_link not in content:
                      content = content.replace('</body>', back_link + '</body>')
                      with open(html_file, 'w', encoding='utf-8') as f:
                          f.write(content)
                      print(f"Injected back link: {html_file}")
              except Exception as e:
                  print(f"Skipped {html_file}: {e}")
          PYEOF

          # Generate all metrics and badges
          python3 << 'EOF'
          import urllib.request
          import json
          import os
          from datetime import datetime, timezone

          def get_color(pct, invert=False):
              try:
                  pct = float(pct)
              except (ValueError, TypeError):
                  return 'lightgrey'
              if invert:  # For complexity/duplication (lower is better)
                  if pct <= 5: return 'brightgreen'
                  elif pct <= 10: return 'green'
                  elif pct <= 20: return 'yellow'
                  else: return 'red'
              else:  # For coverage (higher is better)
                  if pct >= 80: return 'brightgreen'
                  elif pct >= 60: return 'yellow'
                  elif pct >= 40: return 'orange'
                  else: return 'red'

          def get_rating_color(rating):
              return {'A': 'brightgreen', 'B': 'green', 'C': 'yellow', 'D': 'red'}.get(rating, 'lightgrey')

          def download_badge(name, value, color, label=None):
              label = label or name
              url = f'https://img.shields.io/badge/{label}-{value}-{color}'
              try:
                  urllib.request.urlretrieve(url, f'site/coverage/badges/{name}.svg')
                  print(f"Generated {name} badge: {value}")
              except Exception as e:
                  print(f"Failed to generate {name} badge: {e}")

          # Extract coverage percentages
          frontend_cov = 0
          backend_cov = 0

          try:
              with open('coverage/frontend/coverage-summary.json') as f:
                  d = json.load(f)
                  frontend_cov = d['total']['lines']['pct']
          except FileNotFoundError:
              print("WARNING: Frontend coverage artifact not found")
          except (json.JSONDecodeError, KeyError) as e:
              print(f"ERROR: Invalid frontend coverage data: {e}")

          try:
              with open('coverage/backend/coverage.json') as f:
                  d = json.load(f)
                  backend_cov = round(d['totals']['percent_covered'], 1)
          except FileNotFoundError:
              print("WARNING: Backend coverage artifact not found")
          except (json.JSONDecodeError, KeyError) as e:
              print(f"ERROR: Invalid backend coverage data: {e}")

          # Extract complexity metrics
          backend_cc = 0
          backend_mi = 0
          backend_cc_rating = 'N/A'
          backend_mi_rating = 'N/A'
          frontend_complexity_warnings = 0
          frontend_complexity_rating = 'N/A'

          try:
              with open('complexity/backend/summary.json') as f:
                  d = json.load(f)
                  backend_cc = d.get('average_cyclomatic_complexity', 0)
                  backend_mi = d.get('average_maintainability_index', 0)
                  backend_cc_rating = d.get('cc_rating', 'N/A')
                  backend_mi_rating = d.get('mi_rating', 'N/A')
          except FileNotFoundError:
              print("WARNING: Backend complexity artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid backend complexity data: {e}")

          try:
              with open('complexity/frontend/summary.json') as f:
                  d = json.load(f)
                  frontend_complexity_warnings = d.get('complexity_warnings', 0)
                  frontend_avg_cc = d.get('avg_cyclomatic_complexity', 0)
                  frontend_complexity_rating = d.get('rating', 'N/A')
          except FileNotFoundError:
              print("WARNING: Frontend complexity artifact not found")
              frontend_avg_cc = 0
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid frontend complexity data: {e}")
              frontend_avg_cc = 0

          # Extract duplication metrics (frontend)
          duplication_pct = 0
          duplication_rating = 'N/A'
          duplication_clones = 0

          try:
              with open('duplication/frontend/summary.json') as f:
                  d = json.load(f)
                  duplication_pct = d.get('duplication_percentage', 0)
                  duplication_rating = d.get('rating', 'N/A')
                  duplication_clones = d.get('clones_count', 0)
          except FileNotFoundError:
              print("WARNING: Frontend duplication artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid frontend duplication data: {e}")

          # Extract duplication metrics (backend)
          backend_duplication_pct = 0
          backend_duplication_rating = 'N/A'
          backend_duplication_clones = 0

          try:
              with open('duplication/backend/summary.json') as f:
                  d = json.load(f)
                  backend_duplication_pct = d.get('duplication_percentage', 0)
                  backend_duplication_rating = d.get('rating', 'N/A')
                  backend_duplication_clones = d.get('clones_count', 0)
          except FileNotFoundError:
              print("WARNING: Backend duplication artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid backend duplication data: {e}")

          # Extract security metrics
          frontend_vulns = 0
          frontend_security_rating = 'A'
          backend_vulns = 0
          backend_security_rating = 'A'

          try:
              with open('security/frontend/summary.json') as f:
                  d = json.load(f)
                  frontend_vulns = d.get('total_vulnerabilities', 0)
                  frontend_security_rating = d.get('rating', 'A')
          except FileNotFoundError:
              print("WARNING: Frontend security artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid frontend security data: {e}")

          try:
              with open('security/backend/summary.json') as f:
                  d = json.load(f)
                  backend_vulns = d.get('total_vulnerabilities', 0)
                  backend_security_rating = d.get('rating', 'A')
          except FileNotFoundError:
              print("WARNING: Backend security artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid backend security data: {e}")

          # Extract bundle metrics
          bundle_size_kb = 0
          bundle_rating = 'N/A'

          try:
              with open('bundle/frontend/summary.json') as f:
                  d = json.load(f)
                  bundle_size_kb = d.get('total_size_kb', 0)
                  bundle_gzip_kb = d.get('total_gzip_kb', 0)
                  bundle_rating = d.get('rating', 'N/A')
          except FileNotFoundError:
              print("WARNING: Bundle artifact not found")
              bundle_gzip_kb = 0
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid bundle data: {e}")
              bundle_gzip_kb = 0

          # Extract legacy metrics
          legacy_errors = 0
          legacy_warnings = 0
          legacy_complexity_warnings = 0
          legacy_lint_rating = 'N/A'
          legacy_duplication_pct = 0
          legacy_duplication_rating = 'N/A'

          try:
              with open('legacy/lint/summary.json') as f:
                  d = json.load(f)
                  legacy_errors = d.get('errors', 0)
                  legacy_warnings = d.get('warnings', 0)
                  legacy_complexity_warnings = d.get('complexity_warnings', 0)
                  legacy_lint_rating = d.get('rating', 'N/A')
          except FileNotFoundError:
              print("WARNING: Legacy lint artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid legacy lint data: {e}")

          try:
              with open('legacy/duplication/summary.json') as f:
                  d = json.load(f)
                  legacy_duplication_pct = d.get('duplication_percentage', 0)
                  legacy_duplication_rating = d.get('rating', 'N/A')
          except FileNotFoundError:
              print("WARNING: Legacy duplication artifact not found")
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid legacy duplication data: {e}")

          # Validate extracted data before using
          validation_errors = []
          validation_warnings = []

          # Coverage should be 0-100
          if not (0 <= frontend_cov <= 100):
              validation_errors.append(f"Invalid frontend coverage: {frontend_cov}% (expected 0-100)")
              frontend_cov = max(0, min(100, frontend_cov))  # Clamp to valid range
          if not (0 <= backend_cov <= 100):
              validation_errors.append(f"Invalid backend coverage: {backend_cov}% (expected 0-100)")
              backend_cov = max(0, min(100, backend_cov))

          # Bundle size should be positive
          if bundle_size_kb < 0:
              validation_errors.append(f"Invalid bundle size: {bundle_size_kb}KB (expected >= 0)")
              bundle_size_kb = 0
          if bundle_gzip_kb < 0:
              validation_errors.append(f"Invalid gzip bundle size: {bundle_gzip_kb}KB (expected >= 0)")
              bundle_gzip_kb = 0

          # Complexity should be reasonable (CC typically 1-50)
          if backend_cc < 0 or backend_cc > 100:
              validation_warnings.append(f"Unusual backend CC: {backend_cc} (typically 1-50)")
          if frontend_avg_cc < 0 or frontend_avg_cc > 100:
              validation_warnings.append(f"Unusual frontend CC: {frontend_avg_cc} (typically 1-50)")

          # Maintainability index should be 0-100
          if not (0 <= backend_mi <= 100):
              validation_warnings.append(f"Unusual backend MI: {backend_mi} (expected 0-100)")

          # Duplication should be 0-100%
          if not (0 <= duplication_pct <= 100):
              validation_warnings.append(f"Unusual frontend duplication: {duplication_pct}% (expected 0-100)")
          if not (0 <= backend_duplication_pct <= 100):
              validation_warnings.append(f"Unusual backend duplication: {backend_duplication_pct}% (expected 0-100)")

          # Print validation results
          if validation_errors:
              print("\n⚠️  VALIDATION ERRORS (data was corrected):")
              for err in validation_errors:
                  print(f"   - {err}")

          if validation_warnings:
              print("\n⚠️  VALIDATION WARNINGS (unusual values):")
              for warn in validation_warnings:
                  print(f"   - {warn}")

          if not validation_errors and not validation_warnings:
              print("\n✅ All metric values validated successfully")

          # Generate badges
          download_badge('frontend-coverage', f'{frontend_cov}%25', get_color(frontend_cov), 'coverage')
          download_badge('backend-coverage', f'{backend_cov}%25', get_color(backend_cov), 'coverage')
          download_badge('backend-complexity', f'{backend_cc_rating}', get_rating_color(backend_cc_rating), 'complexity')
          download_badge('backend-maintainability', f'{backend_mi_rating}', get_rating_color(backend_mi_rating), 'maintainability')
          download_badge('frontend-complexity', f'{frontend_complexity_rating}', get_rating_color(frontend_complexity_rating), 'complexity')
          download_badge('duplication', f'{duplication_rating}', get_rating_color(duplication_rating), 'duplication')
          download_badge('backend-duplication', f'{backend_duplication_rating}', get_rating_color(backend_duplication_rating), 'duplication')
          download_badge('frontend-security', f'{frontend_security_rating}', get_rating_color(frontend_security_rating), 'security')
          download_badge('backend-security', f'{backend_security_rating}', get_rating_color(backend_security_rating), 'security')
          download_badge('bundle-size', f'{bundle_rating}', get_rating_color(bundle_rating), 'bundle')
          download_badge('legacy-lint', f'{legacy_lint_rating}', get_rating_color(legacy_lint_rating), 'legacy%20lint')
          download_badge('legacy-duplication', f'{legacy_duplication_rating}', get_rating_color(legacy_duplication_rating), 'legacy%20dup')

          # Create metrics.json API file for blog integration
          metrics = {
              'generated_at': datetime.now(timezone.utc).isoformat(),
              'repo': 'matthewdeaves/cookie',
              'coverage': {
                  'frontend': {
                      'percentage': frontend_cov,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/frontend-coverage.svg'
                  },
                  'backend': {
                      'percentage': backend_cov,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/backend-coverage.svg'
                  }
              },
              'complexity': {
                  'backend': {
                      'cyclomatic_complexity': backend_cc,
                      'cyclomatic_rating': backend_cc_rating,
                      'maintainability_index': backend_mi,
                      'maintainability_rating': backend_mi_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/backend-complexity.svg'
                  },
                  'frontend': {
                      'avg_cyclomatic_complexity': frontend_avg_cc,
                      'complexity_warnings': frontend_complexity_warnings,
                      'rating': frontend_complexity_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/frontend-complexity.svg'
                  }
              },
              'duplication': {
                  'frontend': {
                      'percentage': duplication_pct,
                      'clones_count': duplication_clones,
                      'rating': duplication_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/duplication.svg'
                  },
                  'backend': {
                      'percentage': backend_duplication_pct,
                      'clones_count': backend_duplication_clones,
                      'rating': backend_duplication_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/backend-duplication.svg'
                  }
              },
              'security': {
                  'frontend': {
                      'vulnerabilities': frontend_vulns,
                      'rating': frontend_security_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/frontend-security.svg'
                  },
                  'backend': {
                      'vulnerabilities': backend_vulns,
                      'rating': backend_security_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/backend-security.svg'
                  }
              },
              'bundle': {
                  'size_kb': bundle_size_kb,
                  'gzip_kb': bundle_gzip_kb,
                  'rating': bundle_rating,
                  'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/bundle-size.svg'
              },
              'legacy': {
                  'lint': {
                      'errors': legacy_errors,
                      'warnings': legacy_warnings,
                      'complexity_warnings': legacy_complexity_warnings,
                      'rating': legacy_lint_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/legacy-lint.svg'
                  },
                  'duplication': {
                      'percentage': legacy_duplication_pct,
                      'rating': legacy_duplication_rating,
                      'badge_url': 'https://matthewdeaves.github.io/cookie/coverage/badges/legacy-duplication.svg'
                  }
              },
              'links': {
                  'dashboard': 'https://matthewdeaves.github.io/cookie/coverage/',
                  'frontend_coverage': 'https://matthewdeaves.github.io/cookie/coverage/frontend/',
                  'backend_coverage': 'https://matthewdeaves.github.io/cookie/coverage/backend/htmlcov/',
                  'github': 'https://github.com/matthewdeaves/cookie'
              }
          }

          with open('site/coverage/api/metrics.json', 'w') as f:
              json.dump(metrics, f, indent=2)

          print(f"\nMetrics JSON generated at site/coverage/api/metrics.json")
          print(f"Frontend Coverage: {frontend_cov}%")
          print(f"Backend Coverage: {backend_cov}%")
          print(f"Backend Complexity: CC={backend_cc} ({backend_cc_rating}), MI={backend_mi} ({backend_mi_rating})")
          print(f"Frontend Complexity: CC={frontend_avg_cc} ({frontend_complexity_rating}), {frontend_complexity_warnings} ESLint warnings")
          print(f"Duplication: Frontend={duplication_pct}% ({duplication_rating}), Backend={backend_duplication_pct}% ({backend_duplication_rating})")
          print(f"Security: Frontend={frontend_vulns} ({frontend_security_rating}), Backend={backend_vulns} ({backend_security_rating})")
          print(f"Bundle Size: {bundle_size_kb}KB raw, {bundle_gzip_kb}KB gzipped ({bundle_rating})")
          print(f"Legacy Lint: {legacy_errors} errors, {legacy_warnings} warnings ({legacy_lint_rating})")
          print(f"Legacy Duplication: {legacy_duplication_pct}% ({legacy_duplication_rating})")
          EOF

          # Append current metrics to history file
          python3 << 'HISTEOF'
          import json
          import os
          from datetime import datetime, timezone

          history_file = 'site/coverage/history/all.json'
          current_file = 'site/coverage/api/metrics.json'

          # Load existing history
          if os.path.exists(history_file):
              with open(history_file) as f:
                  history = json.load(f)
          else:
              history = {'entries': []}

          # Load current metrics
          with open(current_file) as f:
              current = json.load(f)

          # Use ISO timestamp to preserve intra-day data
          now = datetime.now(timezone.utc)
          timestamp = now.isoformat()
          date = now.strftime('%Y-%m-%d')

          # Build history entry with all trackable metrics
          entry = {
              'timestamp': timestamp,
              'date': date,  # Keep for backwards compatibility with charts
              'coverage': {
                  'frontend': current['coverage']['frontend']['percentage'],
                  'backend': current['coverage']['backend']['percentage']
              },
              'complexity': {
                  'frontend_warnings': current['complexity']['frontend']['complexity_warnings'],
                  'frontend_avg_cc': current['complexity']['frontend'].get('avg_cyclomatic_complexity', 0),
                  'backend_cc': current['complexity']['backend']['cyclomatic_complexity'],
                  'backend_mi': current['complexity']['backend']['maintainability_index']
              },
              'duplication': {
                  'frontend': current['duplication']['frontend']['percentage'],
                  'backend': current['duplication']['backend']['percentage'],
                  'frontend_clones': current['duplication']['frontend']['clones_count'],
                  'backend_clones': current['duplication']['backend']['clones_count']
              },
              'bundle': {
                  'total_kb': current['bundle']['size_kb'],
                  'gzip_kb': current['bundle'].get('gzip_kb', 0)
              },
              'security': {
                  'frontend_vulns': current['security']['frontend']['vulnerabilities'],
                  'backend_vulns': current['security']['backend']['vulnerabilities']
              },
              'legacy': {
                  'errors': current['legacy']['lint']['errors'],
                  'warnings': current['legacy']['lint']['warnings'],
                  'duplication': current['legacy']['duplication']['percentage']
              }
          }

          # Keep all entries (using timestamp as unique key preserves intra-day data)
          history['entries'].append(entry)

          # Sort by timestamp
          history['entries'].sort(key=lambda x: x.get('timestamp', x.get('date', '')))

          # Keep last 200 entries (allows multiple runs per day while keeping ~90 days of history)
          history['entries'] = history['entries'][-200:]

          with open(history_file, 'w') as f:
              json.dump(history, f, indent=2)

          print(f"\nHistory updated: {len(history['entries'])} entries")
          print(f"Latest entry: {timestamp}")
          HISTEOF

          # Create index.html dashboard
          cat > site/coverage/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cookie - Code Quality Dashboard</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                background: #f5f5f5;
                color: #333;
              }
              h1 { font-size: 2rem; margin-bottom: 0.5rem; color: #1a1a1a; }
              .subtitle { color: #666; margin-bottom: 2rem; }
              h2 { font-size: 1.5rem; margin: 2rem 0 1rem; color: #1a1a1a; border-bottom: 2px solid #e1e4e8; padding-bottom: 0.5rem; }
              .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
              .card {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
              }
              .card h3 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                flex-wrap: wrap;
              }
              .card p { color: #666; margin-bottom: 1rem; font-size: 0.9rem; }
              .card a.btn {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.9rem;
              }
              .card a.btn:hover { background: #0052a3; }
              .badge { height: 20px; }
              .metric { font-size: 2rem; font-weight: 700; color: #1a1a1a; }
              .metric-sm { font-size: 1.5rem; }
              .metric-label { font-size: 0.85rem; color: #666; }
              .metrics-row { display: flex; gap: 2rem; margin: 1rem 0; flex-wrap: wrap; }
              .metric-item { text-align: center; }
              .api-note {
                background: #e8f4fd;
                border: 1px solid #b8daff;
                border-radius: 8px;
                padding: 1rem;
                margin-top: 2rem;
              }
              .api-note code {
                background: #fff;
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                font-size: 0.85rem;
              }
              .footer {
                margin-top: 2rem;
                text-align: center;
                color: #999;
                font-size: 0.875rem;
              }
              .footer a { color: #666; }
              .badge-row { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
              .area-tag { font-size: 0.7rem; background: #e0e7ff; color: #3730a3; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 500; vertical-align: middle; }
              code { background: #f3f4f6; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.85rem; }
            </style>
          </head>
          <body>
            <h1>Cookie Code Quality Dashboard</h1>
            <p class="subtitle">Comprehensive code quality metrics across all parts of the codebase</p>

            <h2>Test Coverage</h2>
            <p style="color:#666;margin-bottom:1rem;">Unit test coverage for the frontend React app and backend Django API</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Coverage <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-coverage.svg" alt="Frontend coverage" class="badge">
                </div>
                <p>Vitest coverage for <code>frontend/src/</code> - components, API client, utilities, hooks</p>
                <a href="frontend/index.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Backend Coverage <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-coverage.svg" alt="Backend coverage" class="badge">
                </div>
                <p>pytest-cov coverage for <code>apps/</code> and <code>cookie/</code> - API endpoints, models, services</p>
                <a href="backend/htmlcov/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Code Complexity</h2>
            <p style="color:#666;margin-bottom:1rem;">Cyclomatic complexity and maintainability analysis to identify hard-to-maintain code</p>
            <div class="cards">
              <div class="card">
                <h3>Backend Complexity <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-complexity.svg" alt="Backend complexity" class="badge">
                  <img src="badges/backend-maintainability.svg" alt="Backend maintainability" class="badge">
                </div>
                <p>Cyclomatic complexity and maintainability index (radon) for <code>apps/</code> and <code>cookie/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric" id="backend-cc">-</div>
                    <div class="metric-label">Avg. Complexity</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric" id="backend-mi">-</div>
                    <div class="metric-label">Maintainability</div>
                  </div>
                </div>
                <a href="complexity/radon_report.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Frontend Complexity <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-complexity.svg" alt="Frontend complexity" class="badge">
                </div>
                <p>Cyclomatic complexity analysis for <code>frontend/src/</code> (comparable to backend)</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric" id="frontend-cc">-</div>
                    <div class="metric-label">Avg. Complexity</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric" id="frontend-warnings">-</div>
                    <div class="metric-label">ESLint Warnings</div>
                  </div>
                </div>
              </div>
            </div>

            <h2>Security</h2>
            <p style="color:#666;margin-bottom:1rem;">Dependency vulnerability scanning for npm (frontend) and pip (backend) packages</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Security <span class="area-tag">npm packages</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-security.svg" alt="Frontend security" class="badge">
                </div>
                <p>npm audit - checks <code>frontend/package.json</code> for known vulnerabilities</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="frontend-vulns">-</div>
                    <div class="metric-label">Vulnerabilities</div>
                  </div>
                </div>
              </div>
              <div class="card">
                <h3>Backend Security <span class="area-tag">pip packages</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-security.svg" alt="Backend security" class="badge">
                </div>
                <p>pip-audit - checks <code>requirements.txt</code> for known vulnerabilities</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-vulns">-</div>
                    <div class="metric-label">Vulnerabilities</div>
                  </div>
                </div>
              </div>
            </div>

            <h2>Code Duplication</h2>
            <p style="color:#666;margin-bottom:1rem;">Copy-paste detection to identify repeated code that should be refactored</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Duplication <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/duplication.svg" alt="Duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>frontend/src/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="duplication-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="duplication-clones">-</div>
                    <div class="metric-label">Clones Found</div>
                  </div>
                </div>
                <a href="duplication/frontend/html/index.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Backend Duplication <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-duplication.svg" alt="Backend Duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>apps/</code> and <code>cookie/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-duplication-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-duplication-clones">-</div>
                    <div class="metric-label">Clones Found</div>
                  </div>
                </div>
                <a href="duplication/backend/html/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Bundle Size</h2>
            <p style="color:#666;margin-bottom:1rem;">Production build output size - tracking JS/CSS bundle sizes for the React frontend</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Bundle <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/bundle-size.svg" alt="Bundle size" class="badge">
                </div>
                <p>Vite build output - JavaScript and CSS bundle from <code>frontend/dist/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bundle-gzip">-</div>
                    <div class="metric-label">Gzipped (KB)</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bundle-size">-</div>
                    <div class="metric-label">Raw Size (KB)</div>
                  </div>
                </div>
              </div>
            </div>

            <h2>Legacy Frontend (iOS 9 Compatible)</h2>
            <p style="color:#666;margin-bottom:1rem;">Code quality for the ES5 vanilla JavaScript frontend serving older iOS devices</p>
            <div class="cards">
              <div class="card">
                <h3>Legacy Lint <span class="area-tag">ES5/Vanilla JS</span></h3>
                <div class="badge-row">
                  <img src="badges/legacy-lint.svg" alt="Legacy lint" class="badge">
                </div>
                <p>ESLint ES5 analysis for <code>apps/legacy/static/legacy/js/</code> (iOS 9 compatible)</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-errors">-</div>
                    <div class="metric-label">Errors</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-warnings">-</div>
                    <div class="metric-label">Warnings</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-complexity">-</div>
                    <div class="metric-label">Complexity</div>
                  </div>
                </div>
                <a href="legacy/eslint-report.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Legacy Duplication <span class="area-tag">ES5/Vanilla JS</span></h3>
                <div class="badge-row">
                  <img src="badges/legacy-duplication.svg" alt="Legacy duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>apps/legacy/static/legacy/js/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-dup-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                </div>
                <a href="legacy/duplication/html/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Trends</h2>
            <p style="color:#666;margin-bottom:1rem;">Historical metrics over the last 90 days - track improvements and catch regressions</p>
            <div class="cards">
              <div class="card" style="grid-column: span 2;">
                <h3>Coverage Trends</h3>
                <p>Frontend and backend test coverage over time</p>
                <canvas id="coverageChart" height="120"></canvas>
              </div>
              <div class="card" style="grid-column: span 2;">
                <h3>Code Quality Trends</h3>
                <p>Duplication percentage and complexity warnings</p>
                <canvas id="qualityChart" height="120"></canvas>
              </div>
              <div class="card">
                <h3>Bundle Size Trend</h3>
                <p>Frontend bundle size in KB</p>
                <canvas id="bundleChart" height="150"></canvas>
              </div>
              <div class="card">
                <h3>Security Trend</h3>
                <p>Vulnerability count over time</p>
                <canvas id="securityChart" height="150"></canvas>
              </div>
            </div>
            <p id="history-status" style="color:#999;font-size:0.85rem;margin-top:0.5rem;"></p>

            <div class="api-note">
              <strong>API Endpoint:</strong> Fetch all metrics programmatically for your blog or dashboard:<br>
              <code>GET <a href="api/metrics.json">https://matthewdeaves.github.io/cookie/coverage/api/metrics.json</a></code><br>
              <code>GET <a href="history/all.json">https://matthewdeaves.github.io/cookie/coverage/history/all.json</a></code> (historical data)
            </div>

            <p class="footer">
              Last updated: <span id="date"></span><br>
              <a href="https://github.com/matthewdeaves/cookie">View on GitHub</a>
            </p>

            <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
            <script>
              document.getElementById('date').textContent = new Date().toLocaleString();

              // Chart.js default styling
              Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
              Chart.defaults.color = '#666';

              // Load and render historical trends
              fetch('history/all.json')
                .then(r => r.json())
                .then(history => {
                  const entries = history.entries || [];
                  if (entries.length < 2) {
                    document.getElementById('history-status').textContent =
                      'Trend data will appear after multiple CI runs accumulate historical metrics.';
                    return;
                  }

                  const labels = entries.map(e => e.date);
                  const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                  };

                  // Coverage Chart
                  new Chart(document.getElementById('coverageChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend %', data: entries.map(e => e.coverage?.frontend), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 },
                        { label: 'Backend %', data: entries.map(e => e.coverage?.backend), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 }
                      ]
                    },
                    options: { ...chartOptions, scales: { y: { beginAtZero: false, min: 50, max: 100 } } }
                  });

                  // Quality Chart (duplication + complexity)
                  new Chart(document.getElementById('qualityChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend Dup %', data: entries.map(e => e.duplication?.frontend), borderColor: '#f59e0b', tension: 0.3 },
                        { label: 'Backend Dup %', data: entries.map(e => e.duplication?.backend), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'Frontend Warnings', data: entries.map(e => e.complexity?.frontend_warnings), borderColor: '#8b5cf6', tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  // Bundle Chart
                  new Chart(document.getElementById('bundleChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Size (KB)', data: entries.map(e => e.bundle?.total_kb), borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.1)', fill: true, tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  // Security Chart
                  new Chart(document.getElementById('securityChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend Vulns', data: entries.map(e => e.security?.frontend_vulns), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'Backend Vulns', data: entries.map(e => e.security?.backend_vulns), borderColor: '#f97316', tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  document.getElementById('history-status').textContent =
                    `Showing ${entries.length} data points from ${entries[0]?.date} to ${entries[entries.length-1]?.date}`;
                })
                .catch(() => {
                  document.getElementById('history-status').textContent = 'Historical data not yet available.';
                });

              // Load metrics from API
              fetch('api/metrics.json')
                .then(r => r.json())
                .then(data => {
                  // Complexity
                  document.getElementById('backend-cc').textContent = data.complexity?.backend?.cyclomatic_complexity || '-';
                  document.getElementById('backend-mi').textContent = data.complexity?.backend?.maintainability_index || '-';
                  document.getElementById('frontend-cc').textContent = data.complexity?.frontend?.avg_cyclomatic_complexity || '-';
                  document.getElementById('frontend-warnings').textContent = data.complexity?.frontend?.complexity_warnings ?? '0';

                  // Security
                  document.getElementById('frontend-vulns').textContent = data.security?.frontend?.vulnerabilities ?? '-';
                  document.getElementById('backend-vulns').textContent = data.security?.backend?.vulnerabilities ?? '-';

                  // Duplication
                  document.getElementById('duplication-pct').textContent = (data.duplication?.frontend?.percentage ?? '-') + '%';
                  document.getElementById('duplication-clones').textContent = data.duplication?.frontend?.clones_count ?? '-';
                  document.getElementById('backend-duplication-pct').textContent = (data.duplication?.backend?.percentage ?? '-') + '%';
                  document.getElementById('backend-duplication-clones').textContent = data.duplication?.backend?.clones_count ?? '-';

                  // Bundle (show gzipped size prominently as it's the actual transfer size)
                  document.getElementById('bundle-gzip').textContent = data.bundle?.gzip_kb ?? '-';
                  document.getElementById('bundle-size').textContent = data.bundle?.size_kb ?? '-';

                  // Legacy
                  document.getElementById('legacy-errors').textContent = data.legacy?.lint?.errors ?? '-';
                  document.getElementById('legacy-warnings').textContent = data.legacy?.lint?.warnings ?? '-';
                  document.getElementById('legacy-complexity').textContent = data.legacy?.lint?.complexity_warnings ?? '-';
                  document.getElementById('legacy-dup-pct').textContent = (data.legacy?.duplication?.percentage ?? '-') + '%';
                })
                .catch(() => {});
            </script>
          </body>
          </html>
          HTMLEOF

          # Create root redirect to /coverage/
          cat > site/index.html << 'ROOTHTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0;url=coverage/">
            <title>Redirecting to Cookie Quality Dashboard</title>
          </head>
          <body>
            <p>Redirecting to <a href="coverage/">Quality Dashboard</a>...</p>
          </body>
          </html>
          ROOTHTML

          # Add .nojekyll to prevent Jekyll processing
          touch site/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true
