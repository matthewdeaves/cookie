name: Coverage & Metrics Report

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, master]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish-coverage:
    name: Publish Coverage & Metrics to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v6

      - name: Download frontend coverage
        uses: actions/download-artifact@v7
        with:
          name: frontend-coverage
          path: coverage/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download backend coverage
        uses: actions/download-artifact@v7
        with:
          name: backend-coverage
          path: coverage/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download backend complexity
        uses: actions/download-artifact@v7
        with:
          name: backend-complexity
          path: complexity/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend complexity
        uses: actions/download-artifact@v7
        with:
          name: frontend-complexity
          path: complexity/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend duplication
        uses: actions/download-artifact@v7
        with:
          name: frontend-duplication
          path: duplication/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend security
        uses: actions/download-artifact@v7
        with:
          name: frontend-security
          path: security/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download backend security
        uses: actions/download-artifact@v7
        with:
          name: backend-security
          path: security/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download frontend bundle
        uses: actions/download-artifact@v7
        with:
          name: frontend-bundle
          path: bundle/frontend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        # Critical artifact - must succeed for accurate dashboard

      - name: Download legacy lint
        uses: actions/download-artifact@v7
        with:
          name: legacy-lint
          path: legacy/lint
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download legacy duplication
        uses: actions/download-artifact@v7
        with:
          name: legacy-duplication
          path: legacy/duplication
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download backend duplication
        uses: actions/download-artifact@v7
        with:
          name: backend-duplication
          path: duplication/backend
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download secrets scan
        uses: actions/download-artifact@v7
        with:
          name: secrets-detection
          path: security/secrets
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Fetch existing history from gh-pages
        run: |
          mkdir -p site/coverage/history
          echo "Attempting to fetch history from gh-pages branch..."

          # Try to fetch existing history from gh-pages branch
          if git fetch origin gh-pages --depth=1; then
            echo "Successfully fetched gh-pages branch"

            # List files on gh-pages to debug paths
            echo "Files in gh-pages coverage directory:"
            git ls-tree --name-only origin/gh-pages coverage/ 2>/dev/null || echo "  (coverage/ not found)"
            git ls-tree --name-only origin/gh-pages coverage/history/ 2>/dev/null || echo "  (coverage/history/ not found)"

            # Try to checkout the history file
            if git checkout origin/gh-pages -- coverage/history/all.json 2>/dev/null; then
              echo "Successfully retrieved existing history file"
              mv coverage/history/all.json site/coverage/history/
              echo "Existing history has $(cat site/coverage/history/all.json | python3 -c 'import sys,json; print(len(json.load(sys.stdin).get("entries", [])))') entries"
            else
              echo "No existing history file found on gh-pages, starting fresh"
              echo '{"entries":[]}' > site/coverage/history/all.json
            fi
          else
            echo "Could not fetch gh-pages branch (may not exist yet), starting fresh"
            echo '{"entries":[]}' > site/coverage/history/all.json
          fi

          echo ""
          echo "Current history file contents:"
          cat site/coverage/history/all.json

      - name: Generate coverage and metrics dashboard
        run: |
          # Create site structure with root landing page and coverage subdirectory
          mkdir -p site/coverage/frontend
          mkdir -p site/coverage/backend
          mkdir -p site/coverage/complexity
          mkdir -p site/coverage/security
          mkdir -p site/coverage/duplication
          mkdir -p site/coverage/bundle
          mkdir -p site/coverage/badges
          mkdir -p site/coverage/api
          mkdir -p site/coverage/legacy

          # Copy coverage reports if they exist
          if [ -d "coverage/frontend" ]; then
            cp -r coverage/frontend/* site/coverage/frontend/ 2>/dev/null || true
          fi
          if [ -d "coverage/backend/htmlcov" ]; then
            cp -r coverage/backend/htmlcov site/coverage/backend/ 2>/dev/null || true
          fi

          # Copy complexity reports
          if [ -d "complexity/backend" ]; then
            cp -r complexity/backend/* site/coverage/complexity/ 2>/dev/null || true
          fi
          if [ -d "complexity/frontend" ]; then
            cp -r complexity/frontend/* site/coverage/complexity/ 2>/dev/null || true
          fi

          # Copy security reports
          if [ -d "security/frontend" ]; then
            cp -r security/frontend/* site/coverage/security/ 2>/dev/null || true
          fi
          if [ -d "security/backend" ]; then
            cp -r security/backend/* site/coverage/security/ 2>/dev/null || true
          fi
          if [ -d "security/secrets" ]; then
            cp -r security/secrets/* site/coverage/security/ 2>/dev/null || true
          fi

          # Copy duplication and bundle reports
          if [ -d "duplication/frontend" ]; then
            mkdir -p site/coverage/duplication/frontend
            cp -r duplication/frontend/* site/coverage/duplication/frontend/ 2>/dev/null || true
          fi
          if [ -d "duplication/backend" ]; then
            mkdir -p site/coverage/duplication/backend
            cp -r duplication/backend/* site/coverage/duplication/backend/ 2>/dev/null || true
          fi
          if [ -d "bundle/frontend" ]; then
            cp -r bundle/frontend/* site/coverage/bundle/ 2>/dev/null || true
          fi

          # Copy legacy reports
          if [ -d "legacy/lint" ]; then
            cp -r legacy/lint/* site/coverage/legacy/ 2>/dev/null || true
          fi
          if [ -d "legacy/duplication" ]; then
            mkdir -p site/coverage/legacy/duplication
            cp -r legacy/duplication/* site/coverage/legacy/duplication/ 2>/dev/null || true
          fi

          # Inject "Back to Dashboard" link into all report HTML files
          python3 .github/scripts/inject-back-links.py --site-dir site/coverage

          # Generate all metrics, badges, and API files using extracted script
          python3 .github/scripts/generate-dashboard.py --config .github/scripts/rating-config.json --output site/coverage

          # Note: Metrics extraction, badge generation, and history updates
          # are now handled by generate-dashboard.py above.
          # The dashboard HTML is still generated inline below.

          # Create index.html dashboard
          cat > site/coverage/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cookie - Code Quality Dashboard</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                background: #f5f5f5;
                color: #333;
              }
              h1 { font-size: 2rem; margin-bottom: 0.5rem; color: #1a1a1a; }
              .subtitle { color: #666; margin-bottom: 2rem; }
              h2 { font-size: 1.5rem; margin: 2rem 0 1rem; color: #1a1a1a; border-bottom: 2px solid #e1e4e8; padding-bottom: 0.5rem; }
              .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
              .card {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
              }
              .card h3 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                flex-wrap: wrap;
              }
              .card p { color: #666; margin-bottom: 1rem; font-size: 0.9rem; }
              .card a.btn {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.9rem;
              }
              .card a.btn:hover { background: #0052a3; }
              .badge { height: 20px; }
              .metric { font-size: 2rem; font-weight: 700; color: #1a1a1a; }
              .metric-sm { font-size: 1.5rem; }
              .metric-label { font-size: 0.85rem; color: #666; }
              .metrics-row { display: flex; gap: 2rem; margin: 1rem 0; flex-wrap: wrap; }
              .metric-item { text-align: center; }
              .api-note {
                background: #e8f4fd;
                border: 1px solid #b8daff;
                border-radius: 8px;
                padding: 1rem;
                margin-top: 2rem;
              }
              .api-note code {
                background: #fff;
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                font-size: 0.85rem;
              }
              .footer {
                margin-top: 2rem;
                text-align: center;
                color: #999;
                font-size: 0.875rem;
              }
              .footer a { color: #666; }
              .badge-row { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
              .area-tag { font-size: 0.7rem; background: #e0e7ff; color: #3730a3; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 500; vertical-align: middle; }
              code { background: #f3f4f6; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.85rem; }
            </style>
          </head>
          <body>
            <h1>Cookie Code Quality Dashboard</h1>
            <p class="subtitle">Comprehensive code quality metrics across all parts of the codebase</p>

            <h2>Test Coverage</h2>
            <p style="color:#666;margin-bottom:1rem;">Unit test coverage for the frontend React app and backend Django API</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Coverage <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-coverage.svg" alt="Frontend coverage" class="badge">
                </div>
                <p>Vitest coverage for <code>frontend/src/</code> - components, API client, utilities, hooks</p>
                <a href="frontend/index.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Backend Coverage <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-coverage.svg" alt="Backend coverage" class="badge">
                </div>
                <p>pytest-cov coverage for <code>apps/</code> and <code>cookie/</code> - API endpoints, models, services</p>
                <a href="backend/htmlcov/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Code Complexity</h2>
            <p style="color:#666;margin-bottom:1rem;">Cyclomatic complexity and maintainability analysis to identify hard-to-maintain code</p>
            <div class="cards">
              <div class="card">
                <h3>Backend Complexity <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-complexity.svg" alt="Backend complexity" class="badge">
                  <img src="badges/backend-maintainability.svg" alt="Backend maintainability" class="badge">
                </div>
                <p>Cyclomatic complexity and maintainability index (radon) for <code>apps/</code> and <code>cookie/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric" id="backend-cc">-</div>
                    <div class="metric-label">Avg. Complexity</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric" id="backend-mi">-</div>
                    <div class="metric-label">Maintainability</div>
                  </div>
                </div>
                <a href="complexity/radon_report.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Frontend Complexity <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-complexity.svg" alt="Frontend complexity" class="badge">
                </div>
                <p>Cyclomatic complexity analysis for <code>frontend/src/</code> (comparable to backend)</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric" id="frontend-cc">-</div>
                    <div class="metric-label">Avg. Complexity</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric" id="frontend-warnings">-</div>
                    <div class="metric-label">ESLint Warnings</div>
                  </div>
                </div>
                <a href="complexity/frontend-complexity.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Security</h2>
            <p style="color:#666;margin-bottom:1rem;">Comprehensive security scanning: dependency vulnerabilities, SAST code analysis, and secrets detection</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Security <span class="area-tag">npm packages</span></h3>
                <div class="badge-row">
                  <img src="badges/frontend-security.svg" alt="Frontend security" class="badge">
                </div>
                <p>npm audit - checks <code>frontend/package.json</code> for known vulnerabilities</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="frontend-vulns">-</div>
                    <div class="metric-label">Vulnerabilities</div>
                  </div>
                </div>
              </div>
              <div class="card">
                <h3>Backend Security <span class="area-tag">pip + SAST</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-security.svg" alt="Backend security" class="badge">
                  <img src="badges/bandit-sast.svg" alt="Bandit SAST" class="badge">
                </div>
                <p>pip-audit (dependency vulnerabilities) + Bandit SAST (code analysis)</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-vulns">-</div>
                    <div class="metric-label">pip-audit</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bandit-high" style="color:#e05d44">-</div>
                    <div class="metric-label">HIGH</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bandit-medium" style="color:#dfb317">-</div>
                    <div class="metric-label">MEDIUM</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bandit-low" style="color:#97ca00">-</div>
                    <div class="metric-label">LOW</div>
                  </div>
                </div>
                <a href="security/backend-security.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Secrets Detection <span class="area-tag">detect-secrets</span></h3>
                <div class="badge-row">
                  <img src="badges/secrets-scan.svg" alt="Secrets scan" class="badge">
                </div>
                <p>Scanning for accidentally committed secrets, API keys, and credentials</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="secrets-found">-</div>
                    <div class="metric-label">Secrets Found</div>
                  </div>
                </div>
                <a href="security/secrets-report.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Code Duplication</h2>
            <p style="color:#666;margin-bottom:1rem;">Copy-paste detection to identify repeated code that should be refactored</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Duplication <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/duplication.svg" alt="Duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>frontend/src/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="duplication-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="duplication-clones">-</div>
                    <div class="metric-label">Clones Found</div>
                  </div>
                </div>
                <a href="duplication/frontend/html/index.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Backend Duplication <span class="area-tag">Django/Python</span></h3>
                <div class="badge-row">
                  <img src="badges/backend-duplication.svg" alt="Backend Duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>apps/</code> and <code>cookie/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-duplication-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="backend-duplication-clones">-</div>
                    <div class="metric-label">Clones Found</div>
                  </div>
                </div>
                <a href="duplication/backend/html/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Bundle Size</h2>
            <p style="color:#666;margin-bottom:1rem;">Production build output size - tracking JS/CSS bundle sizes for the React frontend</p>
            <div class="cards">
              <div class="card">
                <h3>Frontend Bundle <span class="area-tag">React/TypeScript</span></h3>
                <div class="badge-row">
                  <img src="badges/bundle-size.svg" alt="Bundle size" class="badge">
                </div>
                <p>Vite build output - JavaScript and CSS bundle from <code>frontend/dist/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bundle-gzip">-</div>
                    <div class="metric-label">Gzipped (KB)</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="bundle-size">-</div>
                    <div class="metric-label">Raw Size (KB)</div>
                  </div>
                </div>
              </div>
            </div>

            <h2>Legacy Frontend (iOS 9 Compatible)</h2>
            <p style="color:#666;margin-bottom:1rem;">Code quality for the ES5 vanilla JavaScript frontend serving older iOS devices</p>
            <div class="cards">
              <div class="card">
                <h3>Legacy Lint <span class="area-tag">ES5/Vanilla JS</span></h3>
                <div class="badge-row">
                  <img src="badges/legacy-lint.svg" alt="Legacy lint" class="badge">
                </div>
                <p>ESLint ES5 analysis for <code>apps/legacy/static/legacy/js/</code> (iOS 9 compatible)</p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-errors">-</div>
                    <div class="metric-label">Errors</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-warnings">-</div>
                    <div class="metric-label">Warnings</div>
                  </div>
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-complexity">-</div>
                    <div class="metric-label">Complexity</div>
                  </div>
                </div>
                <a href="legacy/eslint-report.html" class="btn">View Detailed Report</a>
              </div>
              <div class="card">
                <h3>Legacy Duplication <span class="area-tag">ES5/Vanilla JS</span></h3>
                <div class="badge-row">
                  <img src="badges/legacy-duplication.svg" alt="Legacy duplication" class="badge">
                </div>
                <p>jscpd - copy/paste detection in <code>apps/legacy/static/legacy/js/</code></p>
                <div class="metrics-row">
                  <div class="metric-item">
                    <div class="metric metric-sm" id="legacy-dup-pct">-</div>
                    <div class="metric-label">Duplication %</div>
                  </div>
                </div>
                <a href="legacy/duplication/html/index.html" class="btn">View Detailed Report</a>
              </div>
            </div>

            <h2>Trends</h2>
            <p style="color:#666;margin-bottom:1rem;">Historical metrics over the last 90 days - track improvements and catch regressions</p>
            <div class="cards">
              <div class="card" style="grid-column: span 2;">
                <h3>Coverage Trends</h3>
                <p>Frontend and backend test coverage over time</p>
                <canvas id="coverageChart" height="120"></canvas>
              </div>
              <div class="card" style="grid-column: span 2;">
                <h3>Code Quality Trends</h3>
                <p>Duplication percentage and complexity warnings</p>
                <canvas id="qualityChart" height="120"></canvas>
              </div>
              <div class="card">
                <h3>Bundle Size Trend</h3>
                <p>Frontend bundle size in KB</p>
                <canvas id="bundleChart" height="150"></canvas>
              </div>
              <div class="card">
                <h3>Security Trend</h3>
                <p>Vulnerability count over time</p>
                <canvas id="securityChart" height="150"></canvas>
              </div>
            </div>
            <p id="history-status" style="color:#999;font-size:0.85rem;margin-top:0.5rem;"></p>

            <div class="api-note">
              <strong>API Endpoint:</strong> Fetch all metrics programmatically for your blog or dashboard:<br>
              <code>GET <a href="api/metrics.json">https://matthewdeaves.github.io/cookie/coverage/api/metrics.json</a></code><br>
              <code>GET <a href="history/all.json">https://matthewdeaves.github.io/cookie/coverage/history/all.json</a></code> (historical data)
            </div>

            <p class="footer">
              Last updated: <span id="date"></span><br>
              <a href="https://github.com/matthewdeaves/cookie">View on GitHub</a>
            </p>

            <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
                    integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4"
                    crossorigin="anonymous"></script>
            <script>
              document.getElementById('date').textContent = new Date().toLocaleString();

              // Chart.js default styling
              Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
              Chart.defaults.color = '#666';

              // Load and render historical trends
              fetch('history/all.json')
                .then(r => r.json())
                .then(history => {
                  const entries = history.entries || [];
                  if (entries.length < 2) {
                    document.getElementById('history-status').textContent =
                      'Trend data will appear after multiple CI runs accumulate historical metrics.';
                    return;
                  }

                  const labels = entries.map(e => e.date);
                  const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                  };

                  // Coverage Chart
                  new Chart(document.getElementById('coverageChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend %', data: entries.map(e => e.coverage?.frontend), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 },
                        { label: 'Backend %', data: entries.map(e => e.coverage?.backend), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 }
                      ]
                    },
                    options: { ...chartOptions, scales: { y: { beginAtZero: false, min: 50, max: 100 } } }
                  });

                  // Quality Chart (duplication + complexity)
                  new Chart(document.getElementById('qualityChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend Dup %', data: entries.map(e => e.duplication?.frontend), borderColor: '#f59e0b', tension: 0.3 },
                        { label: 'Backend Dup %', data: entries.map(e => e.duplication?.backend), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'Frontend Warnings', data: entries.map(e => e.complexity?.frontend_warnings), borderColor: '#8b5cf6', tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  // Bundle Chart
                  new Chart(document.getElementById('bundleChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Size (KB)', data: entries.map(e => e.bundle?.total_kb), borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.1)', fill: true, tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  // Security Chart
                  new Chart(document.getElementById('securityChart'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        { label: 'Frontend Vulns', data: entries.map(e => e.security?.frontend_vulns), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'Backend Vulns', data: entries.map(e => e.security?.backend_vulns), borderColor: '#f97316', tension: 0.3 },
                        { label: 'Bandit HIGH', data: entries.map(e => e.security?.bandit_high), borderColor: '#dc2626', tension: 0.3 },
                        { label: 'Bandit MED', data: entries.map(e => e.security?.bandit_medium), borderColor: '#eab308', tension: 0.3 },
                        { label: 'Secrets', data: entries.map(e => e.security?.secrets_found), borderColor: '#7c3aed', tension: 0.3 }
                      ]
                    },
                    options: chartOptions
                  });

                  document.getElementById('history-status').textContent =
                    `Showing ${entries.length} data points from ${entries[0]?.date} to ${entries[entries.length-1]?.date}`;
                })
                .catch(() => {
                  document.getElementById('history-status').textContent = 'Historical data not yet available.';
                });

              // Load metrics from API
              fetch('api/metrics.json')
                .then(r => r.json())
                .then(data => {
                  // Complexity
                  document.getElementById('backend-cc').textContent = data.complexity?.backend?.cyclomatic_complexity || '-';
                  document.getElementById('backend-mi').textContent = data.complexity?.backend?.maintainability_index || '-';
                  document.getElementById('frontend-cc').textContent = data.complexity?.frontend?.avg_cyclomatic_complexity || '-';
                  document.getElementById('frontend-warnings').textContent = data.complexity?.frontend?.complexity_warnings ?? '0';

                  // Security
                  document.getElementById('frontend-vulns').textContent = data.security?.frontend?.vulnerabilities ?? '-';
                  document.getElementById('backend-vulns').textContent = data.security?.backend?.pip_audit_vulns ?? '-';
                  document.getElementById('bandit-high').textContent = data.security?.bandit?.high ?? '-';
                  document.getElementById('bandit-medium').textContent = data.security?.bandit?.medium ?? '-';
                  document.getElementById('bandit-low').textContent = data.security?.bandit?.low ?? '-';
                  document.getElementById('secrets-found').textContent = data.security?.secrets?.found ?? '-';

                  // Duplication
                  document.getElementById('duplication-pct').textContent = (data.duplication?.frontend?.percentage ?? '-') + '%';
                  document.getElementById('duplication-clones').textContent = data.duplication?.frontend?.clones_count ?? '-';
                  document.getElementById('backend-duplication-pct').textContent = (data.duplication?.backend?.percentage ?? '-') + '%';
                  document.getElementById('backend-duplication-clones').textContent = data.duplication?.backend?.clones_count ?? '-';

                  // Bundle (show gzipped size prominently as it's the actual transfer size)
                  document.getElementById('bundle-gzip').textContent = data.bundle?.gzip_kb ?? '-';
                  document.getElementById('bundle-size').textContent = data.bundle?.size_kb ?? '-';

                  // Legacy
                  document.getElementById('legacy-errors').textContent = data.legacy?.lint?.errors ?? '-';
                  document.getElementById('legacy-warnings').textContent = data.legacy?.lint?.warnings ?? '-';
                  document.getElementById('legacy-complexity').textContent = data.legacy?.lint?.complexity_warnings ?? '-';
                  document.getElementById('legacy-dup-pct').textContent = (data.legacy?.duplication?.percentage ?? '-') + '%';
                })
                .catch(() => {});
            </script>
          </body>
          </html>
          HTMLEOF

          # Create root redirect to /coverage/
          cat > site/index.html << 'ROOTHTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0;url=coverage/">
            <title>Redirecting to Cookie Quality Dashboard</title>
          </head>
          <body>
            <p>Redirecting to <a href="coverage/">Quality Dashboard</a>...</p>
          </body>
          </html>
          ROOTHTML

          # Add .nojekyll to prevent Jekyll processing
          touch site/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          keep_files: true
