{% extends 'legacy/base.html' %}
{% load static %}

{% block title %}Cookie - Settings{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'legacy/css/settings.css' %}">
{% endblock %}

{% block content %}
<div class="screen" data-page="settings" data-profile-id="{{ current_profile_id|default:'' }}">
    <!-- Header -->
    <header class="header">
        <a href="{% url 'legacy:home' %}" class="header-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"></path>
                <path d="M19 12H5"></path>
            </svg>
        </a>
        <span class="header-title">Settings</span>
        <div class="header-spacer"></div>
    </header>

    <div class="container container-wide p-4">
        <!-- Tab toggle (6 tabs) -->
        <div class="flex justify-center mb-6">
            <div class="tab-toggle tab-toggle-6">
                <button type="button" class="tab-toggle-btn active" data-tab="general">
                    General
                </button>
                <button type="button" class="tab-toggle-btn" data-tab="prompts">
                    AI Prompts
                </button>
                <button type="button" class="tab-toggle-btn" data-tab="sources">
                    Sources
                </button>
                <button type="button" class="tab-toggle-btn" data-tab="selectors">
                    Selectors
                </button>
                <button type="button" class="tab-toggle-btn" data-tab="users">
                    Users
                </button>
                <button type="button" class="tab-toggle-btn tab-danger" data-tab="danger">
                    Danger Zone
                </button>
            </div>
        </div>

        <!-- General Tab Content -->
        <div id="tab-general" class="tab-content">
            <div class="card">
                <h2 class="settings-section-title">OpenRouter API</h2>

                <!-- Status indicator -->
                <div class="api-status mb-4">
                    <span class="status-dot {% if ai_available %}status-connected{% else %}status-disconnected{% endif %}"></span>
                    <span class="status-text">{% if ai_available %}Connected{% else %}Not configured{% endif %}</span>
                </div>

                {% if ai_available %}
                <div class="api-info mb-4">
                    <span class="api-info-label">Default model:</span>
                    <span class="model-badge" id="current-model">{{ default_model }}</span>
                </div>
                {% endif %}

                <!-- API Key input -->
                <div class="form-group">
                    <label for="api-key-input" class="form-label">
                        {% if ai_available %}Update API Key{% else %}API Key{% endif %}
                    </label>
                    <input
                        type="password"
                        id="api-key-input"
                        class="input"
                        placeholder="sk-or-v1-..."
                    >
                </div>

                <div class="btn-group">
                    <button type="button" id="test-key-btn" class="btn btn-secondary" disabled>
                        <span class="btn-icon-wrapper">
                            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span id="test-key-text">Test Key</span>
                        </span>
                    </button>
                    <button type="button" id="save-key-btn" class="btn btn-primary" disabled>
                        <span class="btn-icon-wrapper">
                            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                            </svg>
                            <span id="save-key-text">Save Key</span>
                        </span>
                    </button>
                </div>

                <p class="api-help-text">
                    Get your API key from
                    <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer" class="link">openrouter.ai/keys</a>
                </p>
            </div>

            <!-- About Section -->
            <div class="card mt-4">
                <h2 class="settings-section-title">About</h2>
                <div class="about-info">
                    <div class="about-row">
                        <span class="about-label">Version</span>
                        <span class="about-value">1.0.0</span>
                    </div>
                    <div class="about-row">
                        <span class="about-label">Source Code</span>
                        <a href="https://github.com/matthewdeaves/cookie.git" target="_blank" rel="noopener noreferrer" class="link about-link">
                            <svg class="about-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                            </svg>
                            GitHub
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompts Tab Content -->
        <div id="tab-prompts" class="tab-content hidden">
            <!-- Info banner -->
            <div class="info-banner mb-4">
                <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
                <div>
                    <strong>AI Prompts Configuration</strong>
                    <p class="info-text">Customize the prompts used for AI features. Each prompt has a system prompt that sets the AI's behavior and a user prompt template with placeholders.</p>
                </div>
            </div>

            {% if not ai_available %}
            <div class="warning-banner mb-4">
                <svg class="warning-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                </svg>
                <span>Configure your OpenRouter API key in the General tab to enable AI features.</span>
            </div>
            {% endif %}

            <!-- Prompt cards -->
            {% for prompt in prompts %}
            <div class="prompt-card" data-prompt-type="{{ prompt.prompt_type }}">
                <div class="prompt-header">
                    <div class="prompt-info">
                        <h3 class="prompt-name">{{ prompt.name }}</h3>
                        {% if not prompt.is_active %}
                        <span class="prompt-disabled-badge">Disabled</span>
                        {% endif %}
                        <p class="prompt-description">{{ prompt.description }}</p>
                        <span class="model-badge">{{ prompt.model }}</span>
                    </div>
                    <div class="prompt-actions">
                        <button type="button" class="btn-expand" data-action="toggle-expand">
                            <svg class="icon-expand" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"></path>
                            </svg>
                            <svg class="icon-collapse hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m18 15-6-6-6 6"></path>
                            </svg>
                        </button>
                        <button type="button" class="btn btn-edit" data-action="edit">Edit</button>
                    </div>
                </div>

                <!-- Expandable content (read-only view) -->
                <div class="prompt-content hidden">
                    <div class="form-group">
                        <label class="form-label form-label-muted">System Prompt</label>
                        <pre class="prompt-text">{{ prompt.system_prompt }}</pre>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label-muted">User Prompt Template</label>
                        <pre class="prompt-text">{{ prompt.user_prompt_template }}</pre>
                    </div>
                </div>

                <!-- Edit form (hidden by default) -->
                <div class="prompt-edit-form hidden">
                    <div class="form-group">
                        <label class="form-label">System Prompt</label>
                        <textarea class="input textarea" rows="6" data-field="system_prompt">{{ prompt.system_prompt }}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">User Prompt Template</label>
                        <textarea class="input textarea" rows="4" data-field="user_prompt_template">{{ prompt.user_prompt_template }}</textarea>
                        <p class="form-help">Use {'{placeholders}'} for dynamic content</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-group-flex">
                            <label class="form-label">Model</label>
                            <select class="input select" data-field="model">
                                {% for model in models %}
                                <option value="{{ model.id }}" {% if model.id == prompt.model %}selected{% endif %}>{{ model.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <button type="button" class="btn-status {% if prompt.is_active %}btn-status-active{% else %}btn-status-disabled{% endif %}" data-field="is_active" data-value="{% if prompt.is_active %}true{% else %}false{% endif %}">
                                {% if prompt.is_active %}Active{% else %}Disabled{% endif %}
                            </button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-action="cancel">
                            <span class="btn-icon-wrapper">
                                <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 6 6 18"></path>
                                    <path d="m6 6 12 12"></path>
                                </svg>
                                Cancel
                            </span>
                        </button>
                        <button type="button" class="btn btn-primary" data-action="save">
                            <span class="btn-icon-wrapper">
                                <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span class="save-btn-text">Save Changes</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Sources Tab Content -->
        <div id="tab-sources" class="tab-content hidden">
            <div class="card">
                <div class="sources-header">
                    <div>
                        <h2 class="settings-section-title">Recipe Sources</h2>
                        <p class="sources-counter" id="sources-counter">Loading...</p>
                    </div>
                    <div class="sources-bulk-actions">
                        <button type="button" id="enable-all-btn" class="btn btn-secondary btn-sm">Enable All</button>
                        <button type="button" id="disable-all-btn" class="btn btn-secondary btn-sm">Disable All</button>
                    </div>
                </div>

                <div id="sources-list" class="sources-list">
                    <!-- Populated by JavaScript -->
                    <div class="loading-placeholder">Loading sources...</div>
                </div>
            </div>
        </div>

        <!-- Selectors Tab Content -->
        <div id="tab-selectors" class="tab-content hidden">
            <div class="card">
                <div class="selectors-header">
                    <div>
                        <h2 class="settings-section-title">Search Source Selector Management</h2>
                        <p class="selectors-subheading">Edit CSS selectors and test source connectivity</p>
                    </div>
                    <button type="button" id="test-all-btn" class="btn btn-primary">
                        <span class="btn-icon-wrapper">
                            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span id="test-all-text">Test All Sources</span>
                        </span>
                    </button>
                </div>

                <div id="selectors-list" class="selectors-list">
                    <!-- Populated by JavaScript -->
                    <div class="loading-placeholder">Loading selectors...</div>
                </div>
            </div>
        </div>

        <!-- Users Tab Content -->
        <div id="tab-users" class="tab-content hidden">
            <div class="card">
                <div class="users-header">
                    <div>
                        <h2 class="settings-section-title">User Management</h2>
                        <p class="users-subheading">Manage user profiles and their data</p>
                    </div>
                    <span class="profile-count" id="profile-count">Loading...</span>
                </div>

                <div id="profiles-list" class="profiles-list">
                    <!-- Populated by JavaScript -->
                    <div class="loading-placeholder">Loading profiles...</div>
                </div>
            </div>
        </div>

        <!-- Danger Zone Tab Content -->
        <div id="tab-danger" class="tab-content hidden">
            <div class="card danger-zone-card">
                <div class="danger-header">
                    <svg class="danger-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <path d="M12 9v4"></path>
                        <path d="M12 17h.01"></path>
                    </svg>
                    <h2 class="settings-section-title danger-title">Danger Zone</h2>
                </div>
                <p class="danger-description">Destructive operations that cannot be undone</p>

                <div class="danger-action">
                    <h3 class="danger-action-title">Reset Database</h3>
                    <p class="danger-action-desc">Completely reset the application to factory state</p>
                    <ul class="delete-list">
                        <li>All recipes (scraped and remixed)</li>
                        <li>All recipe images</li>
                        <li>All user profiles</li>
                        <li>All favorites, collections, and view history</li>
                        <li>All cached AI data</li>
                    </ul>
                    <p class="preserved-note">
                        Search source configurations and AI prompts will be preserved.
                    </p>
                    <button type="button" class="btn btn-danger" onclick="showResetModal()">
                        Reset Database
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Profile Modal -->
    <div id="delete-profile-modal" class="modal-overlay hidden" onclick="closeDeleteModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header modal-header-danger">
                <svg class="modal-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                </svg>
                <h3 class="modal-title">Delete Profile?</h3>
            </div>
            <div class="modal-body">
                <div id="delete-profile-info" class="profile-preview">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="delete-data-summary" class="data-summary">
                    <!-- Populated by JavaScript -->
                </div>
                <p class="warning-text">
                    This action cannot be undone. All data will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn" onclick="executeDeleteProfile()">
                    <span class="btn-icon-wrapper">
                        <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                        <span id="delete-btn-text">Delete Profile</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Database Modal - Step 1 -->
    <div id="reset-modal-step1" class="modal-overlay hidden" onclick="closeResetModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header modal-header-danger">
                <svg class="modal-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                </svg>
                <h3 class="modal-title">Reset Database?</h3>
            </div>
            <div class="modal-body">
                <p class="reset-warning-intro">This will permanently delete ALL data from the application:</p>
                <div id="reset-data-summary" class="data-summary">
                    <!-- Populated by JavaScript -->
                    <div class="loading-placeholder">Loading data summary...</div>
                </div>
                <p class="warning-text">
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeResetModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="showResetStep2()">
                    I understand, continue
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Database Modal - Step 2 -->
    <div id="reset-modal-step2" class="modal-overlay hidden" onclick="closeResetModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header modal-header-danger">
                <svg class="modal-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                </svg>
                <h3 class="modal-title">Confirm Reset</h3>
            </div>
            <div class="modal-body">
                <p class="reset-confirm-text">Type <code class="reset-code">RESET</code> to confirm:</p>
                <input type="text" id="reset-confirm-input" class="input reset-input" placeholder="Type RESET" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="showResetStep1()">
                    Back
                </button>
                <button type="button" class="btn btn-danger" id="confirm-reset-btn" onclick="executeReset()" disabled>
                    <span class="btn-icon-wrapper">
                        <span id="reset-btn-text">Reset Database</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HTML Templates for JavaScript rendering -->
<template id="template-source-item">
    <div class="source-item">
        <div class="source-info">
            <div class="source-name-row">
                <span class="source-name" data-field="name"></span>
                <span class="source-active-badge" data-field="badge"></span>
            </div>
            <span class="source-host" data-field="host"></span>
        </div>
        <button type="button" class="btn-toggle" data-action="toggle-source">
            <!-- Icon inserted by JS -->
        </button>
    </div>
</template>

<template id="template-selector-item">
    <div class="selector-item">
        <div class="selector-header">
            <div class="selector-info">
                <div class="selector-name-row">
                    <span class="selector-name" data-field="name"></span>
                    <span data-field="status-icon"></span>
                </div>
                <span class="selector-host" data-field="host"></span>
                <p class="selector-failure-warning hidden" data-field="failure-warning"></p>
            </div>
            <div class="selector-actions">
                <span class="selector-last-tested" data-field="last-tested"></span>
                <button type="button" class="btn btn-secondary btn-sm" data-action="test-source">
                    <span class="btn-icon-wrapper">
                        <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <span class="test-btn-text">Test</span>
                    </span>
                </button>
            </div>
        </div>
        <div class="selector-field">
            <label class="selector-label">CSS Selector</label>
            <div class="selector-input-row">
                <code class="selector-value" data-field="selector-value"></code>
                <button type="button" class="btn btn-edit btn-sm" data-action="edit-selector">Edit</button>
            </div>
            <div class="selector-edit-row hidden">
                <input type="text" class="input input-mono" data-field="selector">
                <button type="button" class="btn btn-secondary btn-sm" data-action="cancel-edit">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" data-action="save-selector">Save</button>
            </div>
        </div>
    </div>
</template>

<template id="template-profile-card">
    <div class="profile-card">
        <div class="profile-avatar" data-field="avatar"></div>
        <div class="profile-info">
            <div class="profile-name-row">
                <span class="profile-name" data-field="name"></span>
                <span class="profile-current-badge hidden" data-field="badge">Current</span>
            </div>
            <span class="profile-meta" data-field="created"></span>
            <span class="profile-stats" data-field="stats"></span>
        </div>
        <button type="button" class="btn-delete" data-action="delete-profile" title="Delete profile">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
        </button>
    </div>
</template>

<!-- Settings page modules (load order matters) -->
<script src="{% static 'legacy/js/pages/settings-core.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-general.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-prompts.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-sources.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-selectors.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-users.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-danger.js' %}"></script>
<script src="{% static 'legacy/js/pages/settings-init.js' %}"></script>
{% endblock %}
