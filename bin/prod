#!/bin/bash
set -e

# Cookie production helper script
# Usage: bin/prod <command> [args]

cd "$(dirname "$0")/.."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

COMPOSE_FILE="docker-compose.prod.yml"
CONTAINER_NAME="cookie-prod"
IMAGE_NAME="mndeaves/cookie:latest"

usage() {
    echo "Usage: bin/prod <command> [args]"
    echo ""
    echo "Commands:"
    echo "  up, start      Start the production container (port 80)"
    echo "  down, stop     Stop the production container"
    echo "  restart        Restart the production container"
    echo "  pull           Pull the latest image from Docker Hub"
    echo "  update         Pull latest image and restart"
    echo "  logs           View logs (use -f to follow)"
    echo "  status         Show container status"
    echo "  shell          Open a shell in the container"
    echo "  health         Check container health"
    echo "  build          Build production image locally"
    echo "  build-run      Build and run production image locally"
    echo ""
    echo "Examples:"
    echo "  bin/prod up              # Start production on port 80"
    echo "  bin/prod update          # Pull latest and restart"
    echo "  bin/prod logs -f         # Follow logs"
    echo "  bin/prod build-run       # Build and test locally"
}

check_port_80() {
    if lsof -Pi :80 -sTCP:LISTEN -t >/dev/null 2>&1; then
        PROCESS=$(lsof -Pi :80 -sTCP:LISTEN | tail -1 | awk '{print $1}')
        echo -e "${RED}Error: Port 80 is already in use by ${PROCESS}${NC}"
        echo -e "${YELLOW}Stop the other service or use a different port${NC}"
        return 1
    fi
    return 0
}

case "${1:-}" in
    up|start)
        echo -e "${GREEN}Starting production container on port 80...${NC}"
        if ! check_port_80; then
            exit 1
        fi
        docker compose -f "$COMPOSE_FILE" up -d
        echo -e "${GREEN}Production started. Access at http://localhost${NC}"
        echo -e "${CYAN}Tip: Use 'bin/prod logs -f' to watch logs${NC}"
        ;;
    down|stop)
        echo -e "${YELLOW}Stopping production container...${NC}"
        docker compose -f "$COMPOSE_FILE" down
        echo -e "${GREEN}Production stopped.${NC}"
        ;;
    restart)
        echo -e "${YELLOW}Restarting production container...${NC}"
        docker compose -f "$COMPOSE_FILE" restart
        echo -e "${GREEN}Production restarted.${NC}"
        ;;
    pull)
        echo -e "${GREEN}Pulling latest image from Docker Hub...${NC}"
        docker pull "$IMAGE_NAME"
        echo -e "${GREEN}Image updated. Run 'bin/prod restart' to apply.${NC}"
        ;;
    update)
        echo -e "${GREEN}Updating production...${NC}"
        docker pull "$IMAGE_NAME"
        docker compose -f "$COMPOSE_FILE" up -d
        echo -e "${GREEN}Production updated and restarted.${NC}"
        ;;
    logs)
        shift
        docker compose -f "$COMPOSE_FILE" logs "$@"
        ;;
    status)
        docker compose -f "$COMPOSE_FILE" ps
        ;;
    shell)
        echo -e "${GREEN}Opening shell in production container...${NC}"
        docker exec -it "$CONTAINER_NAME" /bin/bash
        ;;
    health)
        echo -e "${GREEN}Checking container health...${NC}"
        if docker exec "$CONTAINER_NAME" curl -sf http://localhost/api/system/health/ >/dev/null 2>&1; then
            HEALTH=$(docker exec "$CONTAINER_NAME" curl -s http://localhost/api/system/health/)
            echo -e "${GREEN}Healthy: ${HEALTH}${NC}"
        else
            echo -e "${RED}Container is not healthy or not running${NC}"
            exit 1
        fi
        ;;
    build)
        echo -e "${GREEN}Building production image locally...${NC}"
        docker build -f Dockerfile.prod -t cookie:local .
        echo -e "${GREEN}Build complete. Image: cookie:local${NC}"
        ;;
    build-run)
        echo -e "${GREEN}Building and running production image locally...${NC}"
        docker build -f Dockerfile.prod -t cookie:local .
        if ! check_port_80; then
            exit 1
        fi
        docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
        docker run -d \
            --name "$CONTAINER_NAME" \
            -p 80:80 \
            -v cookie-prod-data:/app/data \
            -e DEBUG=false \
            -e ALLOWED_HOSTS='*' \
            cookie:local
        echo -e "${GREEN}Production running locally. Access at http://localhost${NC}"
        ;;
    help|-h|--help)
        usage
        ;;
    "")
        usage
        exit 1
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        usage
        exit 1
        ;;
esac
