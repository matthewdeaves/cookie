#!/bin/bash
set -e

# Cookie dev helper script
# Usage: bin/dev <command> [args]

cd "$(dirname "$0")/.."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: bin/dev <command> [args]"
    echo ""
    echo "Commands:"
    echo "  up, start      Start the development stack"
    echo "  down, stop     Stop the development stack"
    echo "  restart        Restart the development stack"
    echo "  build          Rebuild the Docker images"
    echo "  logs           View logs (use -f to follow)"
    echo "  test           Run pytest"
    echo "  shell          Open Django shell"
    echo "  manage <cmd>   Run Django manage.py command"
    echo "  exec <cmd>     Execute command in web container"
    echo "  migrate        Run database migrations"
    echo "  makemigrations Create new migrations"
    echo "  status         Show container status"
    echo ""
    echo "Examples:"
    echo "  bin/dev up              # Start the stack"
    echo "  bin/dev test            # Run tests"
    echo "  bin/dev logs -f         # Follow logs"
    echo "  bin/dev manage createsuperuser"
}

case "${1:-}" in
    up|start)
        echo -e "${GREEN}Starting development stack...${NC}"
        docker compose up -d
        echo -e "${GREEN}Stack started. Access at http://localhost${NC}"
        ;;
    down|stop)
        echo -e "${YELLOW}Stopping development stack...${NC}"
        docker compose down
        echo -e "${GREEN}Stack stopped.${NC}"
        ;;
    restart)
        echo -e "${YELLOW}Restarting development stack...${NC}"
        docker compose restart
        echo -e "${GREEN}Stack restarted.${NC}"
        ;;
    build)
        echo -e "${GREEN}Building Docker images...${NC}"
        docker compose build
        ;;
    logs)
        shift
        docker compose logs "$@"
        ;;
    test)
        shift
        echo -e "${GREEN}Running tests...${NC}"
        docker compose exec -T web python -m pytest "$@"
        ;;
    shell)
        echo -e "${GREEN}Opening Django shell...${NC}"
        docker compose exec web python manage.py shell
        ;;
    manage)
        shift
        docker compose exec web python manage.py "$@"
        ;;
    exec)
        shift
        docker compose exec web "$@"
        ;;
    migrate)
        echo -e "${GREEN}Running migrations...${NC}"
        docker compose exec web python manage.py migrate
        ;;
    makemigrations)
        shift
        echo -e "${GREEN}Creating migrations...${NC}"
        docker compose exec web python manage.py makemigrations "$@"
        ;;
    status)
        docker compose ps
        ;;
    help|-h|--help)
        usage
        ;;
    "")
        usage
        exit 1
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        usage
        exit 1
        ;;
esac
